# 分布式

## 如何保证消息不会丢

> 常见的消息队列有 RabbitMQ, Kafka

从三个方面来分析，如何保证消息不会丢失
- 生产消息
- 存储消息
- 消费消息

 
1. 生产阶段 =》 生产者生产消息发送到 broker，如果发送成功，要等 broker 响应后才可继续发送下一个消息；  
   如果发送失败到 broker 失败，则要做好报警通知 和 日志记录，方便排查和处理。
2. 存储阶段 =》 存储消息，务必要等 消息落盘后，broker在响应生产者。
3. 消费阶段 =》 消费者一定要等业务逻辑真正执行完后，在发送给 broker 消息成功。




## 消息队列中，如何处理重复消息

> 常见的消息队列有 RabbitMQ, Kafka  

### 生产者 和 消费者
_**生产者**_ -> 在消息写入到 broker 后，要等 broker 响应后才算写入完成。  

_**消费者**_ -> 从 broker 成功获取到消息，并成功消费了，事务也提交了，但是在更新 consumer offset时，
         消费者挂了，没有更新上；然后另外一个消费者开始消费，发现这个 consumer offset 还没更新，
         然后消息又重新消费执行了一遍了， 这就导致了重复处理了。

因此从这两个来看，无论是生产者还是消费者都会重复消费，是不可避免的。

### 解决 
要解决重复消费的核心逻辑就是 要支持幂等原则

从业务角度来规避重复消费的问题  
- 记录关键的key，比如订单ID 或者 订单号，如果订单ID已经被处理过，则直接跳过。  
- 数据库的版本号，比如乐观锁，把版本号添加成前置条件，只有满足了版本号才能更新，否则拒绝更新。  
- 数据库里已经有一条记录了，如果又来一条同样的消息，则可以通过数据库约束拒绝掉。



## 日志

**_日志有哪些作用？_**
- 定位错误
- 分析用户的行为（访问时长，浏览时间段，DAU，对商品的喜好，调用链路）